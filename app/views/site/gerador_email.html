{% extends "site/master.html" %} {% block content %}


<section class="uk-container uk-margin-medium-bottom" uk-height-viewport="expand: true">

  <div class="uk-width-1-1">


    <div class="uk-margin-large">

      <form id="form1">
        <div class="loading_bg">
          <div class="loadding_container uk-flex uk-flex-center uk-flex-middle">
            <div class="lds-dual-ring"></div>
          </div>
        </div>
        <fieldset>
          <h2>Imagem Banner Top</h2>

          <div uk-margin>
            <label>Link</label>
            <input type="text" class="uk-input" id="linkTop" required>
          </div>
          <div uk-form-custom>
            <input type="file" accept="image/*" id="fileBannerTop" required>
            <button class="uk-button uk-button-default" type="button" tabindex="-1">Selecione o banner top</button>
          </div>
          <div class="uk-box"><img width="300" id="preview-bannerTop" /></div>
          <button class="uk-button uk-button-default enviar" id="enviarBannerTop">Envia Imagem banner top</button>
        </fieldset>
      </form>

      <form id="form2" style="background-color: #9ab699">
        <div class="loading_bg">
          <div class="loadding_container uk-flex uk-flex-center uk-flex-middle">
            <div class="lds-dual-ring"></div>
          </div>
        </div>
        <fieldset>
          <h2>Imagem Banner Bottom</h2>

          <div uk-margin>
            <label>Link</label>
            <input type="text" class="uk-input" id="linkBottom" required>
          </div>
          <div uk-form-custom>
            <input type="file" accept="image/*" id="fileBannerBottom" required>
            <button class="uk-button uk-button-default" type="button" tabindex="-1">Selecione o banner Bottom</button>
          </div>
          <div class="uk-box"><img width="300" id="preview-bannerBottom" /></div>
          <button class="uk-button uk-button-default enviar" id="enviarBannerBottom">Envia Imagem banner Bottom</button>
        </fieldset>
      </form>

      <div uk-grid class=" uk-grid-match uk-child-width-expand uk-margin-large-bottom">
        <div class="uk-width-1-3@m">
          Nome do Botão

          <input type="text" class="uk-input" value="Comprar" id="F_name_btn">
        </div>

        <div class="uk-width-1-3@m">
          Tamanho da fonte do botão

          <input type="number" class="uk-input" value="20" id="F_fonte_btn">
        </div>

        <div class="uk-width-1-3@m">
          Cor do texto do botão
          <input type="color" class="uk-input" value="#1a2265" id="F_fonte_color_btn">
        </div>

        <div>
          Cor do botão
          <input type="color" class="uk-input" value="#ffffff" id="F_color_btn">
        </div>

        <div>
          Titulo do E-mail
          <input type="text" class="uk-input" value="Confira também:" id="title_text">
        </div>

        <div>
          Tamanho da fonte do titulo
          <input type="number" class="uk-input" value="30" id="title_font">
        </div>

        <div>
          <button class="uk-button uk-height-1-1" onClick="button_style()">
            Confirmar
          </button>
        </div>
      </div>

      <script>

        function button_style() {

          alert('Confirmado');



          let all_btn_comprar = document.querySelectorAll(".btn_comprar");

          all_btn_comprar.forEach(element => {
            console.log(element);

            element.innerHTML = document.getElementById('F_name_btn').value;
            element.style.fontSize = document.getElementById('F_fonte_btn').value + 'px';
            element.style.color = document.getElementById('F_color_btn').value;
            element.style.backgroundColor = document.getElementById('F_fonte_color_btn').value;
          })

          let titulo_master = document.getElementById('titulo_master')

          titulo_master.innerHTML = document.getElementById('title_text').value;
          titulo_master.style.fontSize = document.getElementById('title_font').value + 'px';


        }
      </script>

      <div class="uk-child-width-1-2@s" uk-grid>

        <div>

          <aside class="uk-width-expand produto uk-margin-large-bottom">
            <form class="uk-search uk-search-default uk-width-1-1">
              <input class="uk-search-input" type="search" placeholder="Search" id="search">
            </form>
          </aside>

          <div class="uk-flex uk-flex-center">
            <div class="lds-hourglass"></div>
          </div>
          <div uk-slider>
            <div class="uk-position-ralative">
              <div id="match-list" class="uk-grid uk-child-width-1-3@m"></div>
              <a class="uk-position-center-left uk-position-small uk-hidden-hover" href="#" uk-slidenav-previous
                uk-slider-item="previous"></a>
              <a class="uk-position-center-right uk-position-small uk-hidden-hover" href="#" uk-slidenav-next
                uk-slider-item="next"></a>
            </div>

          </div>
        </div>

        <div>
          <div uk-grid class="uk-child-width-expand">
            <div>
              <article>
                <input type="checkbox" style="font-size: 11px;" id="desconto" />
                <div>
                  <span>
                    Esconder Preço
                  </span>
                </div>
              </article>
            </div>
            <button class="uk-button uk-button-secondary " style="font-size: 11px;" id="apagar">Remover ultimo
              item</button>

            <form method="post" action="{{ base_path }}/download" target="_blank">

              <input class="uk-hidden" class="miolo" type="text" name="miolo" id="miolo" placeholder="site">

              <input type="submit" class="uk-button" id="baixar_html" id="baixar" style="font-size: 11px;"
                value="Fazer Download">
            </form>
          </div>

          <div id="enviado_complete"> </div>

          <aside id="email">




            <table id="regua_email" class="email" align="center" bgcolor="#fff" style="border-collapse:collapse;"
              width="600" height="" border="0" cellpadding="0" cellspacing="0">

              <tr class="Confira">
                <td>
                  <p style="color:#ef7d52;text-align: center;font-family:Arial;margin-top:25px;margin-bottom:15px;">
                    <span style="line-height: 100%;font-weight: 700;font-size: 30px;" id="titulo_master">Confira
                      também:</span>
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <table align="center" style="border-collapse:collapse;" width="560" id="galeria">

                  </table>
                </td>
              </tr>

            </table>



          </aside>
        </div>

      </div>
    </div>
  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"
  integrity="sha512-u9akINsQsAkG9xjc1cnGF4zw5TFDwkxuc9vUp5dltDWYCSmyd0meygbvgXrlc/z7/o4a19Fb5V0OUE58J7dcyw=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

  document.getElementById("fileBannerTop").onchange = function () {
    var reader = new FileReader();
    reader.onload = function (e) {
      // get loaded data and render thumbnail.
      document.getElementById("preview-bannerTop").src = e.target.result;
      var previewImg = document.getElementById("preview-bannerTop");
      var lembrar_img = previewImg;
    };
    // read the image file as a data URL.
    reader.readAsDataURL(this.files[0]);
  };

  document.getElementById("fileBannerBottom").onchange = function () {
    var reader = new FileReader();
    reader.onload = function (e) {
      // get loaded data and render thumbnail.
      document.getElementById("preview-bannerBottom").src = e.target.result;
      var previewImg = document.getElementById("preview-bannerBottom");
      var lembrar_img = previewImg;
    };
    // read the image file as a data URL.
    reader.readAsDataURL(this.files[0]);
  };


  const url_enviarImagem = "{{ base_path }}/gravarImagem";

  const url = "{{ base_path }}/api_produto_manole/mostrar";

  /*----------------------------------------------------------------------------------------------------*/
  /*--------------------------------------------BAnner top -----------------------------------------*/
  /*----------------------------------------------------------------------------------------------------*/

  const formDataTop = new FormData();
  const fileBannerTop = document.getElementById('fileBannerTop');
  const form1 = document.getElementById('form1');



  form1.addEventListener('submit', function (evt) {
    formDataTop.append("banner", fileBannerTop.files[0]);
    evt.preventDefault();

    form1.classList.add('loader');
    document.querySelector('.enviar').disabled = true;

    axios({
      method: 'post',
      url: url_enviarImagem,
      headers: { 'Content-Type': 'multipart/form-data' },
      data: formDataTop,
    }).then(
      response => {
        console.log(response.data);
        document.getElementById("preview-bannerTop").removeAttribute('src');

        form1.classList.remove('loader');
        Swal.fire({
          icon: 'success',
          title: 'Sucesso!',
          text: 'Banner top com sucesso!'
        }
        );


        const tr_t = document.createElement("TR");
        const td_t = document.createElement("TD");
        const table_t = document.createElement("table");

        tr_t.appendChild(td_t);
        td_t.appendChild(table_t);
        table_t.setAttribute("id", "email_banner_top");
        table_t.setAttribute("cellspacing", "0");
        table_t.setAttribute("cellpadding", "0");
        table_t.setAttribute("border", "0");

        document.getElementById("regua_email").insertBefore(tr_t, document.getElementById("regua_email").childNodes[0]);
        table_t.style.borderCollapse = 'collapse';

        const regex = /.*?:\["(.*?)"\].*?./gm;
        let imagens = response.data[0].banner;

        let linkTop = document.getElementById('linkTop');

        let url_final_t = linkTop.value;
        /*
                array_imagens.forEach(function callback(value, index) {
                  alert(index);
                  alert(value);
                });*/


        let m;

        while ((m = regex.exec(imagens)) !== null) {

          if (m.index === regex.lastIndex) {
            regex.lastIndex++;
          }

          m.forEach((match, groupIndex) => {
            if ((groupIndex / 2) != 0) {
              let produto = `<tr><td><a title="Manole" href="${url_final_t}" target="_blank"><img style="display:block;border:none;" alt="Manole" src='https://manolemarketing.s3.amazonaws.com/2022/images/${match}'/></a></td><tr>`;
              document.getElementById("email_banner_top").innerHTML += produto;
            }
          });
        }

        document.querySelector('.enviar').disabled = false;
        form1.reset();
      }
    ).catch(function (error) {
      console.log(error);
      body.classList.remove('loader');
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'Ocorreu um erro ao se cadastrar'
      })
    });

  });

  /*----------------------------------------------------------------------------------------------------*/
  /*--------------------------------------------BAnner Bottom -----------------------------------------*/
  /*----------------------------------------------------------------------------------------------------*/

  const formDataBottom = new FormData();
  const fileBannerBottom = document.getElementById('fileBannerBottom');
  const form2 = document.getElementById('form2');


  form2.addEventListener('submit', function (evt) {
    formDataBottom.append("banner", fileBannerBottom.files[0]);
    evt.preventDefault();

    form2.classList.add('loader');
    document.querySelector('.enviar').disabled = true;

    axios({
      method: 'post',
      url: url_enviarImagem,
      headers: { 'Content-Type': 'multipart/form-data' },
      data: formDataBottom,
    }).then(
      response => {
        console.log(response.data);
        document.getElementById("preview-bannerBottom").removeAttribute('src');

        form2.classList.remove('loader');
        Swal.fire({
          icon: 'success',
          title: 'Sucesso!',
          text: 'Banner bottom enviada com sucesso!'
        }
        );

        const tr_b = document.createElement("TR");
        const td_b = document.createElement("TD");
        const table_b = document.createElement("table");

        tr_b.appendChild(td_b);
        td_b.appendChild(table_b);
        table_b.setAttribute("id", "email_banner_bottom");
        table_b.setAttribute("cellspacing", "0");
        table_b.setAttribute("cellpadding", "0");
        table_b.setAttribute("border", "0");

        document.getElementById("regua_email").appendChild(tr_b);

        table_b.style.borderCollapse = 'collapse';

        const regex = /.*?:\["(.*?)"\].*?./gm;
        let imagens = response.data[0].banner;

        let linkBottom = document.getElementById('linkBottom');

        let url_final_b = linkBottom.value;
        /*
                array_imagens.forEach(function callback(value, index) {
                  alert(index);
                  alert(value);
                });*/


        let m;

        while ((m = regex.exec(imagens)) !== null) {

          if (m.index === regex.lastIndex) {
            regex.lastIndex++;
          }

          m.forEach((match, groupIndex) => {
            if ((groupIndex / 2) != 0) {
              document.getElementById("email_banner_bottom").innerHTML += `<tr><td><a title="Manole" href="${url_final_b}" target="_blank"><img style="display:block;border:none;" alt="Manole" src='https://manolemarketing.s3.amazonaws.com/2022/images/${match}'/></a></td><tr>`;
            }
          });
        }
        form2.reset();
        document.querySelector('.enviar').disabled = false;
      }
    ).catch(function (error) {
      console.log(error);
      body.classList.remove('loader');
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'Ocorreu um erro ao se cadastrar'
      })
    });

  });

  /*----------------------------------------------------------------------------------------------------*/
  /*--------------------------------------------Atualizar Json-----------------------------------------*/
  /*----------------------------------------------------------------------------------------------------*/

  /*
  document.getElementById('atualizar_json').addEventListener("click", function () {

    document.getElementById('loading_json').classList.add('loader');
    document.getElementById('atualizar_json').disabled = true;


    axios({
      method: 'get',
      url: url,

    }).then(
      response => {
        console.log(response.data);
        document.getElementById('loading_json').classList.remove('loader');
        Swal.fire({
          icon: 'success',
          title: 'Json!',
          text: 'Atualizado um sucesso'
        }
        );
        document.getElementById('atualizar_json').disabled = false;
        document.getElementById('json_date').innerHTML = response.data.data;
      }
    ).catch(function (error) {
      console.log(error);
      document.getElementById('loading_json').classList.remove('loader');
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'Ocorreu um erro ao atualizar'
      })
    });
  });*/


  const search = document.getElementById('search');
  const matchList = document.getElementById('match-list');
  const table = document.querySelector('#galeria');
  const apagar = document.querySelector('#apagar');
  const baixar = document.getElementById('baixar');
  const email = document.getElementById('email');
  const body = document.querySelector('body');

  const baixar_html = document.querySelector('#baixar_html');
  const miolo = document.querySelector('#miolo');

  baixar_html.addEventListener("click", function (e) {
    var aHtml = JSON.stringify(email.innerHTML);
    miolo.value = aHtml;

    enviado_complete.innerHTML = '<div class="uk-button uk-button-primary uk-width-1-1 uk-margin-top" style="background:green">Enviado</div>';

  });




  //procura no json e filtra eles

  const searchStates = async searchText => {
    body.classList.add('loader');

    const res = await fetch("{{ base_path }}/api_produto_manole/mostrar");

    //     const res = await fetch("http://localhost/Generator_Email_Marketing/public/master_manole.json"); 
    const states = await res.json();

    //faz o match entre o texto teclado e o json

    let matches = states.filter(state => {
      const regex = new RegExp(`${searchText}`, 'gi');

      return state.nome.match(regex) || state.skul.match(regex) || state.link.match(regex);

    });

    if (searchText.length === 0 || matches.length == 0) {
      matches = [];

      matchList.innerHTML = "";
    }

    outputHtml(matches);
    console.log(matches);
  };


  const outputHtml = matches => {

    body.classList.remove('loader');

    if (matches.length > 0) {

      const html = matches.map(match =>
        ` 
        <aside class="hover_list_produt">
        <div class="produto uk-margin-large uk-position-relative">
   
          <a alt="${match.categoria}" class="link" href="#" style="text-decoration: none; width: 580px; display: block;" title="${match.link}"></a>
    <table border="0" cellpadding="0" cellspacing="0" height="" width="580">
        <tr>
            <td height="" width="42">
                <tr>
                    <td align="left" height="" style="display: block; border: none; width: 100%; height: auto" valign="middle" width="183">
                        <img alt="${match.nome}" class="img" src="${match.img}" style="display: block; border: none; width: 183px; height: 183px;" />
                    </td>
                  </tr>
                  <tr>
                    <td colspan="3" height="" width="272">
                        <table class="list_produto" border="0" cellpadding="0" cellspacing="0" height="152" width="183">
                            <tr>
                                <td align="center" height="34" valign="middle" width="200">
                                <div>
                                  <span
                                        class="skul uk-hidden"  >
                                        ${match.skul}
                                    </span>
                                    <span class="categoria" >
                                        ${match.categoria}
                                    </span>
                                    <span   class="porcentagem uk-hidden"   >
                                        ${match.desconto}
                                    </span>
                                    </div>
                                    <div  class="nome"   >
                                        ${match.nome}
                                    </div>
                                    <div class="de uk-hidden">De: ${match.de}</div>
                                    <div class="por uk-hidden">Por: ${match.por}</div>
                                    <div class="uk-hidden" style="color:#000;font-size: 12px;line-height:110%;font-weight:900;font-family: Arial;padding: 2px 2px;text-decoration: none;margin:5px 0px;">Até <span class="parcela" style="color:red;font-size: 14px;line-height:110%;font-weight:900;font-family: Arial;">${match.parcela}</span> de <span class="valor_parcela" style="color:red;font-size: 14px;line-height:110%;font-weight:900;font-family: Arial;">${match.valor_parcela}</span> <strong style="font-weight:700">sem juros<strong></div>
                                    <tr>
                                        <td height="40" valign="middle" width="254">
                                          <a href="${match.link}" class="btn_a btn_comprar">COMPRAR!</a>
                                        </td>
                                    </tr>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td height="" width="49"></td>
                </tr>
            </td>
        </tr>
    </table>
</div>
</aside>

        `).join('');

      console.log(html);
      matchList.innerHTML = html;

      let produtos = document.querySelectorAll('.produto');

      for (let i = 0; i < produtos.length; i++) {

        produtos[i].addEventListener('click', function (e) {

          let nome = this.querySelector(".nome");
          let link = this.querySelector(".link");
          let de = this.querySelector(".de");
          let por = this.querySelector(".por");
          let imagem = this.querySelector(".img");
          let parcela = this.querySelector(".parcela");
          let promocao = this.querySelector(".promocao");
          let valor_parcela = this.querySelector(".valor_parcela");
          let porcentagem = this.querySelector(".porcentagem");

          limite = document.querySelector('#galeria').childElementCount;
          let desconto = document.querySelector('#desconto');
          limite = limite - 1;



          if (limite % 2 != 0) {
            table.innerHTML +=
              `<tr>
              <td>
             
                <a style="text-decoration: none;margin:5px 0px; width: 580px; margin-top: 25px;margin-bottom: 35px;display: block;" href="${link.title}"  title="${nome.textContent}"  target="_blank">
                  <table width="580" height="" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                      <td width="42" height="186"> </td>
                      <td width="183" height="186" style="display:block;border:none; width:183px; height:183px;" align="center" valign="middle">
                        <img style="display:block;border:none; width:183px; height:183px;" src="${imagem.src}" alt="${nome.textContent} "> 
                      </td>
                      <td width="43" height="186"> </td>
                      <td colspan="3" width="272" height="186">
                        <table width="265" height="152" border="0" cellpadding="0" cellspacing="0"> 
                          <tr>
                            <td align="center" valign="middle" width="264" height="34">
                              <div data="name" style="font-weight:500;color:#0b066d;font-size: 16px;line-height:1.6;text-align: center;font-family: Arial;padding: 2px 2px;text-decoration: none;margin:5px 0px;text-transform: uppercase;">
                                ${nome.textContent}</div>  
                          </td>
                        </tr>
                        <tr>
                          <td width="264" height="40" valign="middle">
                          <div class="btn_comprar" style="color:#fff;text-align: center;font-family: Arial;text-decoration: none;margin:5px 0px;font-weight:800;letter-spacing: 0px;padding: 12px 0px;background: #1a2265;border-radius: 40px;font-size:20px;">COMPRAR</div>
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td width="49" height="186"> </td>
                </tr>
              </table>
            </a>
          </td>
        </tr>`
              ;
          } else {
            table.innerHTML +=
              `<tr> 
              <td>
                <a style="text-decoration: none;margin:5px 0px; width: 580px;margin-top: 25px;margin-bottom: 35px;display: block;" href="${link.title}" title="${nome.textContent}" target="_blank">
                  <table width="580" height="" border="0" cellpadding="0" cellspacing="0">
                    <td width="42" height="186"> </td>
                    <td colspan="3" width="272" height="186"> 
                      <table width="272" height="152" border="0" cellpadding="0" cellspacing="0"> <tr>
                        <td align="center" valign="middle" width="264" height="34">
                           <div data="name" style="font-weight:500;color:#0b066d;font-size: 16px;line-height:1.6;text-align: center;font-family: Arial;padding: 2px 2px;text-decoration: none;margin:5px 0px;text-transform: uppercase;">${nome.textContent}</div>
                         
                       </td>
                    </tr>
                    <tr>
                      <td width="264" height="40" valign="middle">
                        <div class="btn_comprar" style="color:#fff;text-align: center;font-family: Arial;text-decoration: none;margin:5px 0px;font-weight:800;letter-spacing: 0px;padding: 12px 0px;background: #1a2265;border-radius: 40px;font-size:20px;">COMPRAR</div>
                      </td>
                    </tr>
                  </table>
                    </td>
                    <td width="43" height="186"> </td><td width="183" height="186" style="display:block;border:none; width:183px; height:183px;" align="center" valign="middle">
                      <img style="display:block;border:none; width:183px; height:183px;" src="${imagem.src}" alt="${nome.textContent}"> </td><td width="49" height="186"> 
                      </td>
                    </table>
                  </a>
                </td>
              </tr>`
              ;
          }



        }, false);
      }
    };



  };

  search.addEventListener('input', () => searchStates(search.value)); // Ele reage ao envento de qualque input dentro do campo search. Cada input vai formando um Array de caracteres para dentro do e depois ele manda isso para fazer a busca no searchStates


  apagar.addEventListener('click', function (e) {
    table.removeChild(table.lastElementChild);
  }, false);




</script>
{% endblock %}
